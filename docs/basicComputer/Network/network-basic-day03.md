---
autoGroup-1: 网络基础
sidebarDepth: 3
title: 四次挥手/同源策略
---

## 关闭TCP的四次挥手
`FIN`：`finish` 关闭连接  

状态：
- `FIN-WAIT-1` 等待远程`TCP`的连接中断请求，或先前的连接中断请求的确认
- `FIN-WAIT-2` 从远程`TCP`等待连接中断请求
- `CLOSE-WAIT` 等待从本地用户发来的连接中断请求
- `LAST-ACK` 等待原来发向远程`TCP`的连接中断请求的确认
- `TIME-WAIT` 等待足够的时间以确保远程`TCP`接受到连接中断请求的确认
- `CLOSE` 没有任何连接状态

四次挥手流程：
 <img :src="$withBase('/basicComputer/Network/four-way-handshake.png')" alt="four-way-handshake"> 


1. 客户端发送连接关闭报文（此时已停止发送数据）（第一次挥手）
   - 报文头部：`FIN=1`（序列号`seq=u`）
   - 此刻：客户端进入终止等待`1`状态（`FIN-WAIT-1`）
2. 服务器接到连接关闭报文，并发送确认报文（第二次挥手）
   - 报文首部：`ACK=1 ack=u+1`（确认`FIN`）（序列号`seq=v`）
   - 此刻：服务端进入关闭等待状态（`CLOSE-WAIT`）
   - 说明：连接半关闭状态，客户端没有数据要发送，但服务器如果还要发送数据，客户端依然需要接受。
3. 客户端收到服务器的确认请求后，客户端进入终止等待`2`状态（`FIN-WAIT-2`）
   - 服务器在这期间还要确认客户端所需要的数据是否真的发送完毕了，如果还没发送完，则继续发送数据
4. 服务器确认数据已发送完毕后，向客户端发送连接关闭报文（第三个挥手），服务器进入最后确认状态（`LAST-ACK`）
    - 报文首部：`FIN=1 ACK=1 ack=u+1`（确认上一次数据包）序列号`seq=w`
5. 客户端收到服务器的连接关闭报文后，发出接受确认报文（第四次挥手），客户端进入时间等待状态（`TIME-WAIT`）
    - 报文首部：`ACK=1 ack=w+1`(确认上一次数据包) 序列号`seq=u+1`
6. 服务器收到客户端的确认，立即进入`TCP`关闭状态（`CLOSE`），`TCP`连接结束
   - `TCP`关闭，服务端要比客户端早一些

`TIME-WAIT`时长：`MSL Maximum Segment Lifetime` 最大报文生存时间。`MSL`的值根据不同情况而不同，一般是`30`秒 `1`分钟 `2`分钟。  
目的：保证客户端发送的最后一个报文能够发到服务器，一旦报文丢失，服务器会认为自己最后一次发送的`FIN+ACK`包，客户端没有收到，此时，服务器会重新发送一次`FIN+ACK`包，而客户端可以在`2MSL`的`TIME-WAIT`时间内收到重新传输的`FIN+ACK`包，接着重新进行第四次挥手，并重启`2MSL`计时器。


为什么是四次挥手？   
原因：第一次挥手的时候发送了`FIN`包，服务器接收到以后，表示客户端不再发送数据了，但还能接收数据。这时服务器先向客户端先发送确认包，并且确认自己是否还有数据没有发送给客户端，这个确认的阶段就是`CLOSE-WAIT`，所以在终止等待`2`（`CLOSE_WAIT`）的开始和结束需要各发一个包，状态开始时向客户端发送的包是确认收到来自客户端的`FIN`包，状态结束时向客户端发送的是确认数据已经完整发送，所以四次挥手。


`TCP`连接建立后，客户端突然出现故障？   
`TCP`保活计时器：客户端如果出现故障，服务器每收到一次客户端的请求后都会重新复位保活计时器，时间通常是`2`小时，若`2`小时还没有收到客户端的数据，服务器就会发送一个探测报文段，以后每隔`75`分钟发送一次。若一连发送`10`个探测报文仍无反应，服务器就认为客户端出了故障，此时将关闭连接。

## 同源策略
同源策略`Same-Origin-Policy(SOP)`   
`web`浏览器只允许在两个页面有相同的源时，第一个页面访问第二个页面里的数据。   
源（域名）：协议+域名+端口   
同源：相同的协议&&相同的域名&&相同的端口    
同源策略是浏览器的一个安全功能，不同源的客户端脚本在没有明确授权的情况下，不能读写对方的资源。只有同一个源的脚本赋予`dom`、读写`cookies`、`session`、`ajax`等操作的权限。   

不受同源策略限制的项：
1. 页面的超链接
2. 重定向页面
3. 表单的提交
4. 资源引入`script src`/`link href`/`img src`/`iframe src`

只要有`JS`引擎的浏览器都使用同源策略。


